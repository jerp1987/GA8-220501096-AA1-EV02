<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>SECLICA | Agendar Cita</title>
  <link rel="stylesheet" type="text/css" href="css/bootstrap.css" />
  <link rel="stylesheet" type="text/css" href="css/style.css" />
  <link rel="stylesheet" type="text/css" href="css/responsive.css" />
  <style>
    #msg.alert { margin-top:12px; }
    .hero_area { min-height: 120px; margin-bottom: 30px; }
  </style>
</head>
<body>
  <!-- ========== PROTECCIÓN DE ACCESO: SOLO USUARIO AUTENTICADO ========== -->
  <script>
    // Si no hay usuario autenticado en sessionStorage, redirige a acceso
    if (!sessionStorage.getItem('auth_user')) {
      window.location.href = "acceso.html";
    }
  </script>
  <!-- ========== MENÚ SUPERIOR FUNCIONAL PARA CLIENTE ========== -->
  <div class="hero_area">
    <div class="hero_bg_box">
      <img src="images/hero-bg.jpg" alt="">
    </div>
    <header class="header_section">
      <div class="header_top">
        <div class="container-fluid header_top_container">
          <div class="contact_nav">
            <a href="#"><i class="fa fa-map-marker"></i><span>Localización</span></a>
            <a href="#"><i class="fa fa-phone"></i><span>Cel 3507348436</span></a>
            <a href="#"><i class="fa fa-envelope"></i><span>jhonn1987jerp@gmail.com</span></a>
          </div>
          <div class="social_box">
            <a href="https://www.facebook.com/tucuenta" target="_blank"><i class="fa fa-facebook"></i></a>
            <a href="https://twitter.com/tucuenta" target="_blank"><i class="fa fa-twitter"></i></a>
            <a href="https://www.linkedin.com/in/tucuenta" target="_blank"><i class="fa fa-linkedin"></i></a>
            <a href="https://www.instagram.com/tucuenta" target="_blank"><i class="fa fa-instagram"></i></a>
          </div>
        </div>
      </div>
      <div class="header_bottom">
        <div class="container-fluid">
          <nav class="navbar navbar-expand-lg custom_nav-container">
            <a class="navbar-brand" href="index.html">SECLICA</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
                    aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
              <span class="navbar-toggler-icon" style="color:white;">&#9776;</span>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
              <ul class="navbar-nav">
                <!-- SOLO enlaces de módulos permitidos para cliente autenticado -->
                <li class="nav-item"><a class="nav-link" href="citas.html">CITAS AGENDADAS</a></li>
                <li class="nav-item"><a class="nav-link" href="cancelar_citas.html">CANCELAR CITA</a></li>
                <!-- Botón de cerrar sesión para el cliente -->
                <li class="nav-item">
                  <button id="btnLogout" class="btn btn-danger btn-sm ml-2" style="margin-top:6px;">
                    CERRAR SESIÓN
                  </button>
                </li>
              </ul>
            </div>
          </nav>
        </div>
      </div>
    </header>
  </div>
  <!-- ========== FIN MENÚ ========== -->

<!-- FORMULARIO AGENDAR CITA -->
  <section class="contact_section">
    <div class="container">
      <div class="col-md-8 mx-auto">
        <div class="form_container">
          <div class="heading_container heading_center">
            <h2>Agendar Cita</h2>
          </div>
          <form id="formAgendar" autocomplete="off">
            <div class="form-row">
              <div class="form-group col-md-6">
                <label for="nombre">Nombre</label>
                <input type="text" name="nombre" id="nombre" class="form-control" disabled>
              </div>
              <div class="form-group col-md-6">
                <label for="apellido">Apellido</label>
                <input type="text" name="apellido" id="apellido" class="form-control" disabled>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group col-md-6">
                <label for="tipo_documento">Tipo de documento</label>
                <input type="text" name="tipo_documento" id="tipo_documento" class="form-control" disabled>
              </div>
              <div class="form-group col-md-6">
                <label for="numero_documento">Número de documento</label>
                <input type="text" name="numero_documento" id="numero_documento" class="form-control" disabled>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group col-md-6">
                <label for="correo">Correo electrónico</label>
                <input type="email" name="correo" id="correo" class="form-control" disabled>
              </div>
              <div class="form-group col-md-6">
                <label for="telefono">Teléfono</label>
                <input type="tel" name="telefono" id="telefono" class="form-control" disabled>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group col-md-6">
                <label for="fecha">Fecha</label>
                <input type="date" name="fecha" id="fecha" class="form-control" required>
              </div>
              <div class="form-group col-md-6">
                <label for="placa_vehiculo">Placa del vehículo</label>
                <input type="text" name="placa_vehiculo" id="placa_vehiculo" class="form-control" required>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group col-12">
                <label for="servicio">Servicio</label>
                <select name="servicio" id="servicio" class="form-control" required>
                  <option value="">Seleccione un servicio</option>
                  <option value="Mantenimiento Preventivo">Mantenimiento Preventivo</option>
                  <option value="Sincronización">Sincronización</option>
                  <option value="Reparación Motor">Reparación Motor</option>
                  <option value="Sistema Eléctrico">Sistema Eléctrico</option>
                  <option value="Sistema Alimentación">Sistema Alimentación</option>
                  <option value="Sistemas Frenos">Sistemas Frenos</option>
                  <option value="Sistema Lubricación">Sistema Lubricación</option>
                  <option value="Sistema Dirección">Sistema Dirección</option>
                  <option value="Sistema Alimentación Combustible">Sistema Alimentación Combustible</option>
                  <option value="Sistema Suspensión">Sistema Suspensión</option>
                  <option value="Sistema Electrónico y eléctrico">Sistema Electrónico y eléctrico</option>
                  <option value="Scanner OBD1/OBD2">Scanner OBD1/OBD2</option>
                  <option value="Análisis Gases">Análisis Gases</option>
                  <option value="Mecánica Rápida">Mecánica Rápida</option>
                  <option value="Otros">Otros</option>
                </select>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group col-12">
                <label for="descripcion_adicional">Descripción adicional</label>
                <textarea name="descripcion_adicional" id="descripcion_adicional" class="form-control"></textarea>
              </div>
            </div>
            <div class="btn_box text-center">
              <button type="submit" class="btn btn-success px-4" id="btnAgendar">Agendar</button>
            </div>
            <div id="mensaje_alerta" class="alert d-none mt-3" role="alert"></div>
          </form>
        </div>
      </div>
    </div>
  </section>

<!-- info section y footer -->
<section class="info_section mt-4 mb-5" style="background:#53b597; border-radius:18px 18px 0 0; padding-top:32px; padding-bottom:0;">
  <div class="container">
    <div class="info_top">
      <div class="row">
        <div class="col-md-12 text-center">
          <span class="navbar-brand" style="font-size:2.2em; color:#F7B500; font-weight:700; letter-spacing:2px; margin-bottom:8px; display:inline-block;">
            SECLICA
          </span>
          <p class="mt-2" style="font-size:1.13em; color:#fff; margin-bottom:0.6em;">
            Somos una empresa prestadora de servicios especializados en mecánica 
            de motocicletas de 2T y 4T en Bogotá.<br>
            Presentamos a nuestros clientes un portafolio que abarca todo lo relacionado 
            con los principales sistemas: inyección, lubricación, alimentación, dirección, 
            frenos, transmisión y refrigeración.
          </p>
        </div>
      </div>
    </div>
  </div>
  <!-- Footer legal y template info -->
  <footer style="background:#14632D; color:#fff; border-radius:0 0 18px 18px; padding:22px 0 10px 0; margin-top:38px;">
    <div class="container text-center">
      <p style="margin-bottom:8px; font-size:1.13em; letter-spacing:1px; font-weight:600;">
        SECLICA
      </p>
      <small style="color:#fff; opacity:0.87;">
        © 2025 SECLICA. Todos los derechos reservados.<br>
        Desarrollado con <a href="https://getbootstrap.com/" target="_blank" style="color:#F7B500; text-decoration:underline;">Bootstrap</a>
      </small>
    </div>
  </footer>
</section>

<footer class="footer_section">
  <div class="container">
    <p>
      &copy; <span id="displayYear"></span> All Rights Reserved By
      <a href="https://html.design/">Free Html Templates</a>
    </p>
  </div>
</footer>

<script>
document.getElementById('displayYear').textContent = new Date().getFullYear();

// 1. Validación de sesión:
const user = sessionStorage.getItem('auth_user');
if (!user) {
  alert("Debes iniciar sesión para agendar una cita.");
  window.location.href = "acceso.html";
}

// 2. Llenar automáticamente los campos y deshabilitarlos
const usuario = JSON.parse(sessionStorage.getItem('auth_user') || '{}');

// Campo nombre
if (usuario.nombre) {
  document.getElementById("nombre").value = usuario.nombre;
  document.getElementById("nombre").readOnly = true;
}

// Campo apellido
if (usuario.apellido) {
  document.getElementById("apellido").value = usuario.apellido;
  document.getElementById("apellido").readOnly = true;
}

// Campo correo (puede llamarse 'correo' o 'email')
if (usuario.correo || usuario.email) {
  document.getElementById("correo").value = usuario.correo || usuario.email;
  document.getElementById("correo").readOnly = true;
}

// Campo teléfono
if (usuario.telefono) {
  document.getElementById("telefono").value = usuario.telefono;
  document.getElementById("telefono").readOnly = true;
}

// Campo número de documento (en tu BD es 'identificacion')
if (usuario.identificacion || usuario.numero_documento) {
  document.getElementById("numero_documento").value = usuario.identificacion || usuario.numero_documento;
  document.getElementById("numero_documento").readOnly = true;
}

// Campo tipo de documento (select)
if (usuario.tipo_documento) {
  document.getElementById("tipo_documento").value = usuario.tipo_documento;
  document.getElementById("tipo_documento").disabled = true;
}

// SCRIPTS NECESARIOS PARA AGENDAR CITA
const BASE = "/SECLICA/public";
const form = document.getElementById("formAgendar");
const btn = document.getElementById("btnAgendar");
const msg = document.getElementById("mensaje_alerta");

form.addEventListener("submit", async function(e){
  e.preventDefault();
  msg.className = "alert d-none mt-3";
  btn.disabled = true;

  // Solo enviamos los campos editables y los personales de la sesión
  const data = {
    nombre: usuario.nombre,
    apellido: usuario.apellido,
    tipo_documento: usuario.tipo_documento,
    numero_documento: usuario.identificacion,
    correo: usuario.email,
    telefono: usuario.telefono,
    fecha: document.getElementById("fecha").value,
    placa_vehiculo: document.getElementById("placa_vehiculo").value,
    servicio: document.getElementById("servicio").value,
    descripcion_adicional: document.getElementById("descripcion_adicional").value
  };

  // Validación rápida
  if (!data.fecha || !data.placa_vehiculo || !data.servicio) {
    msg.textContent = "⚠️ Por favor completa todos los campos obligatorios.";
    msg.className = "alert alert-warning mt-3";
    btn.disabled = false;
    return;
  }

  try {
    const res = await fetch(`${BASE}/api/agendar_cita.php`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data),
      credentials: "include"  // <--- ¡Línea clave!
    });
    const json = await res.json();

    if(json.success){
      msg.textContent = "✅ ¡Cita agendada exitosamente!";
      msg.className = "alert alert-success mt-3";
      form.reset();
    } else if(json.error && json.error.includes("registrado")) {
      msg.textContent = "⚠️ Debes estar registrado para agendar una cita.";
      msg.className = "alert alert-warning mt-3";
      setTimeout(() => { window.location.href = "acceso.html"; }, 2200);
    } else {
      msg.textContent = "❌ Error al agendar cita: " + (json.message || json.error || "No se pudo agendar la cita.");
      msg.className = "alert alert-danger mt-3";
    }
  } catch (err) {
    msg.textContent = "⚠️ Error de conexión. Intenta de nuevo.";
    msg.className = "alert alert-danger mt-3";
  } finally {
    btn.disabled = false;
  }
});

// ========== FUNCIÓN UNIVERSAL DE CERRAR SESIÓN ==========
document.getElementById('btnLogout').onclick = function() {
  fetch('/SECLICA/public/api/logout.php', { method: 'POST', credentials: 'include' })
    .finally(() => {
      sessionStorage.removeItem('auth_user'); // Borra storage local
      window.location.href = "index.html";    // Redirige a home o acceso
    });
};
</script>

</body>
</html>